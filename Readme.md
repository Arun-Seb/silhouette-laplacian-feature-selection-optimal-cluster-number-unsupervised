# Optimal Cluster Number and Feature Selection using Silhouette Analysis

[![MATLAB](https://img.shields.io/badge/MATLAB-R2019b%2B-orange.svg)](https://www.mathworks.com/products/matlab.html)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Paper](https://img.shields.io/badge/DOI-10.1109%2FEMBC46164.2021.9630150-blue)](https://doi.org/10.1109/EMBC46164.2021.9630150)

MATLAB implementation of an unsupervised feature selection algorithm combining silhouette analysis with Laplacian score for optimal clustering. Originally developed for identifying the predominant site of upper airway collapse in obstructive sleep apnoea (OSA) patients using acoustic features from snore signals.

## ğŸ“š Publication

This implementation is based on:

> **Sebastian, A., Cistulli, P. A., Cohen, G., & de Chazal, P.** (2021). "Unsupervised Approach for the Identification of the Predominant Site of Upper Airway Collapse in Obstructive Sleep Apnoea Patients Using Snore Signals." *43rd Annual International Conference of the IEEE Engineering in Medicine & Biology Society (EMBC)*, 961-964. 
> 
> DOI: [10.1109/EMBC46164.2021.9630150](https://doi.org/10.1109/EMBC46164.2021.9630150)

## ğŸ¯ Overview

The algorithm performs unsupervised feature selection through a five-step process:

1. **Data Loading**: Load feature matrix with optional labels
2. **Optimal Cluster Detection**: Evaluates silhouette scores for k=1 to 6 clusters for each feature using majority voting
3. **Uniformity Filtering**: Selects features with balanced cluster distributions (40-60% threshold)
4. **Feature Ranking**: Ranks features using Laplacian Score based on locality-preserving power
5. **Sequential Selection**: Adds features sequentially until first maximum silhouette score is reached

### Key Results from Paper
- **Optimal clusters**: 2 (tongue/non-tongue collapse)
- **Features selected**: 17 out of 50 acoustic features
- **Mean silhouette coefficient**: 0.79
- **Classification accuracy**: 68% for predominant site-of-collapse identification

## âœ¨ Features

- âœ… **Fully unsupervised** - No ground truth labels required for feature selection
- âœ… **Automatic feature selection** - Combines silhouette analysis, uniformity testing, and Laplacian score
- âœ… **Built-in validation** - Silhouette analysis for cluster quality assessment
- âœ… **Patient-level analysis** - Identifies predominant patterns across multiple events
- âœ… **Comprehensive visualization** - Multiple plots showing selection process and results
- âœ… **Well-documented code** - Extensive comments explaining each step
- âœ… **Synthetic data generator** - Test the algorithm without real data
- âœ… **Ready to use** - Complete working example included

## ğŸš€ Quick Start

### Prerequisites

- MATLAB R2019b or later
- Statistics and Machine Learning Toolbox
- `fsulaplacian` function for Laplacian Score calculation

### Installation

```bash
git clone https://github.com/yourusername/optimal-cluster-feature-selection.git
cd optimal-cluster-feature-selection
```

### Running the Example

```matlab
% Step 1: Generate synthetic data (or use your own)
run('SampleDataGenerator.m');

% Step 2: Run the feature selection algorithm
run('OptimalClusterFeatureSelection.m');

% The script will:
% - Load data from generatedData.mat
% - Find optimal cluster number
% - Select features based on uniformity
% - Rank features using Laplacian Score
% - Sequentially add features
% - Generate visualizations
% - Save results to optimal_feature_selection_results.mat
```

## ğŸ“ Repository Structure

```
optimal-cluster-feature-selection/
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ OptimalClusterFeatureSelection.m    % Main analysis script
â”œâ”€â”€ SampleDataGenerator.m                % Generate synthetic OSA data
â”œâ”€â”€ fsulaplacian.m                       % Laplacian Score function
â”œâ”€â”€ data/
â”‚   â””â”€â”€ generatedData.mat                % Synthetic data (auto-generated)
â””â”€â”€ results/
    â””â”€â”€ optimal_feature_selection_results.mat  % Output (auto-generated)
```

## ğŸ“Š Data Structure

### Input: `generatedData.mat`

Generated by `SampleDataGenerator.m`, contains:

| Variable | Dimensions | Description |
|----------|------------|-------------|
| `sampleData` | n_samples Ã— 57 | Feature matrix (56 features + 1 label column) |
| `data_len` | 1 Ã— n_patients | Number of events per patient |
| `PSOC_M` | 1 Ã— n_patients | Patient-level ground truth labels ('T'=Tongue, 'N'=Non-tongue) |

**Feature Structure (columns 1-56):**
- **Time-domain**: Energy, Entropy, Zero-crossing rate
- **Formants**: F1, F2, F3
- **MFCC**: 13 coefficients (columns 7-19)
- **Î”MFCC**: 13 first derivatives (columns 20-32)
- **Chroma**: 12 spectral features (columns 33-44)
- **Spectral**: Entropy, Flux, Centroid, Roll-off, Fundamental & Harmonic frequencies (columns 45-56)
- **Labels** (column 57): 0=Lateral wall, 1=Palate, 2=Tongue-base

### Output: `optimal_feature_selection_results.mat`

| Variable | Description |
|----------|-------------|
| `feat_relev` | Indices of ranked features |
| `best_n_feat` | Optimal number of features selected |
| `opt` | Performance metrics array (6 Ã— n_features) |
| `max_silh` | Maximum silhouette score achieved |
| `data` | Selected feature data |
| `idx` | Final cluster assignments |
| `PSOC_A` | Predicted patient-level labels |
| `PSOC_M` | Ground truth patient-level labels |

## ğŸ“– Detailed Usage

### Using the Provided Scripts

```matlab
%% Method 1: Complete Pipeline
% Generate synthetic data
run('SampleDataGenerator.m');  
% Output: generatedData.mat with sampleData, data_len, PSOC_M

% Run analysis
run('OptimalClusterFeatureSelection.m');
% Output: optimal_feature_selection_results.mat and visualizations
```

### Using Your Own Data

```matlab
% Prepare your data in the required format
sampleData = [your_features, your_labels];  % n_samples Ã— (n_features + 1)
data_len = [events_per_patient];            % 1 Ã— n_patients
PSOC_M = {'T', 'N', 'T', ...};             % 1 Ã— n_patients (optional)

% Save in the expected format
save('generatedData.mat', 'sampleData', 'data_len', 'PSOC_M');

% Run the analysis script
run('OptimalClusterFeatureSelection.m');
```

### Modifying Parameters

Edit `OptimalClusterFeatureSelection.m` to change:

```matlab
% Line ~130: Uniformity threshold (default: 40-60%)
feat_sel = find(opt(4,:) < 0.6*size(sampleData,1) & opt(4,:) > 0.4*size(sampleData,1));

% Line ~105: Cluster range to test (default: 1-6)
E = evalclusters(X, 'kmeans', 'Silhouette', 'klist', [1:6]);

% Line ~184: Predominance threshold (default: 60%)
predom_val = 0.6;

% Line ~120: Distance metric (default: sqeuclidean)
idx = kmeans(X, 2, 'Distance', 'sqeuclidean', 'Display', 'off');
```

## ğŸ” Algorithm Steps

### Step 1: Data Loading
```matlab
load('generatedData.mat')  % Loads sampleData, data_len, PSOC_M
```

### Step 2: Optimal Cluster Number Detection
- For each feature, evaluate silhouette scores for k=1 to 6
- Use **majority voting** across all features to determine optimal k
- Typically results in k=2 for binary classification problems

### Step 3: Feature Selection by Uniformity
- Perform 2-means clustering on each feature
- Calculate cluster sizes
- **Discard features** where one cluster contains >60% or <40% of data
- Ensures balanced, informative features

### Step 4: Laplacian Score Ranking
```matlab
[rnk_feat, scores] = fsulaplacian(X, 'Distance', 'seuclidean');
```
- Ranks features by locality-preserving power
- Lower Laplacian scores indicate better features

### Step 5: Sequential Feature Addition
- Add features one by one in ranked order
- Calculate silhouette score at each step
- **Stop at first maximum** silhouette score
- Evaluate against ground truth if available

## ğŸ“ˆ Visualization

The algorithm generates three comprehensive figures:

### Figure 1: Feature Selection Process (4 subplots)
1. **Silhouette Score vs Features**: Shows quality improvement
2. **Patient Accuracy vs Features**: Patient-level classification performance
3. **Event Accuracy vs Features**: Event-level classification performance  
4. **Optimal K vs Features**: Stability of cluster number

### Figure 2: 2D Clustering Visualization
- Scatter plot using first two selected features
- Color-coded by cluster assignment
- Highlights correctly classified points

### Figure 3: Silhouette Diagram
- Silhouette plot for final clustering
- Shows cluster quality and balance
- Mean silhouette coefficient displayed

## ğŸ§ª Synthetic Data Generator

### Running the Generator

```matlab
run('SampleDataGenerator.m');
```

### What It Creates

The `SampleDataGenerator.m` script generates:
- **~1807 samples** mimicking hypopnoea events
- **56 acoustic features** (MFCC, spectral, temporal features)
- **54-58 patients** with varying event counts (15-50 events each)
- **Balanced labels**: ~45% non-tongue, ~55% tongue-base collapse
- **Realistic distributions**: Features with clustering tendency
- **Patient-level predominance**: â‰¥60% rule enforced

### Output File

```matlab
% generatedData.mat contains:
% - sampleData: [1807 Ã— 57] double
% - data_len: [1 Ã— 54] double  
% - PSOC_M: {1 Ã— 54} cell array of 'T' or 'N'
```

### Customizing Synthetic Data

Edit parameters in `SampleDataGenerator.m`:
```matlab
n_patients = 54;                    % Number of patients
events_per_patient = [15, 50];      % Min/max events
tongue_prevalence = 0.55;           % Proportion with tongue collapse
predominance_threshold = 0.6;       % Classification threshold
```

## ğŸ”§ Troubleshooting

### Issue: "No features passed uniformity test"

**Cause**: All features have highly imbalanced clusters (>60% in one cluster)

**Solutions**:
1. Relax the threshold (line ~130):
   ```matlab
   feat_sel = find(opt(4,:) < 0.7*size(sampleData,1) & opt(4,:) > 0.3*size(sampleData,1));
   ```

2. Check your data distribution:
   ```matlab
   histogram(opt(4,:)/size(sampleData,1))
   ```

3. Normalize/standardize features before clustering

### Issue: "Undefined function 'fsulaplacian'"

**Solution**: Ensure `fsulaplacian.m` is in your MATLAB path or download from File Exchange

### Issue: Poor clustering results

**Diagnostics**:
```matlab
% Check feature distributions
for i = 1:min(10, size(sampleData,2)-1)
    subplot(2,5,i); histogram(sampleData(:,i)); title(['Feature ' num2str(i)]);
end

% Check for outliers
boxplot(sampleData(:,1:min(20,end-1)));
```

**Solutions**:
- Normalize features: `sampleData = normalize(sampleData)`
- Remove outliers using robust statistics
- Try different distance metrics: `'correlation'`, `'cityblock'`

### Issue: Memory errors with large datasets

**Solutions**:
```matlab
% Process in batches
batch_size = 1000;
for i = 1:batch_size:size(sampleData,1)
    batch = sampleData(i:min(i+batch_size-1,end),:);
    % Process batch
end
```

## ğŸ“Š Expected Results

When running on synthetic data generated by `SampleDataGenerator.m`:

```
Loaded 54 patients with 56 features
Total samples: ~1807

Step 2: Optimal cluster number (majority vote): 2
Number of features agreeing: ~40/56 (71%)

Step 3: Features passing uniformity test: ~27/56

Step 4: Features ranked by Laplacian score (top 10 shown)

Step 5: Sequential Feature Addition
Features: 1-17 | Silhouette: 0.5-0.79 | Accuracy: 60-70%

=== Results ===
Best number of features: ~17
Maximum silhouette score: ~0.79
Patient-level accuracy: ~37/54 (68%)
Event-level accuracy: ~65-70%
```

## ğŸ“ Applications

This algorithm is suitable for:

- **Sleep medicine**: OSA site-of-collapse identification, sleep stage classification
- **Biomedical signal analysis**: ECG, EEG, EMG feature selection
- **Acoustic analysis**: Speech recognition, speaker identification, sound classification
- **High-dimensional data**: Gene expression, spectral features, sensor data
- **Unsupervised learning**: When labels are unavailable or expensive to obtain
- **Pattern recognition**: Identifying natural groupings in complex data

## ğŸ“„ Citation

If you use this code in your research, please cite:

```bibtex
@inproceedings{sebastian2021unsupervised,
  title={Unsupervised Approach for the Identification of the Predominant Site 
         of Upper Airway Collapse in Obstructive Sleep Apnoea Patients Using 
         Snore Signals},
  author={Sebastian, Arun and Cistulli, Peter A and Cohen, Gary and 
          de Chazal, Philip},
  booktitle={2021 43rd Annual International Conference of the IEEE Engineering 
             in Medicine \& Biology Society (EMBC)},
  pages={961--964},
  year={2021},
  organization={IEEE},
  doi={10.1109/EMBC46164.2021.9630150}
}
```

## ğŸ‘¥ Authors

**Original Algorithm & Publication:**
- **Arun Sebastian** (Lead Author) - University of Sydney
- Peter A. Cistulli - University of Sydney  
- Gary Cohen - Royal North Shore Hospital
- Philip de Chazal - University of Sydney

**Code Implementation:**
- Based on original MATLAB implementation by Arun Sebastian
- Documentation and repository by Arun Sebastian



## ğŸ“ Contact

**For questions about the algorithm:**
- Email: arunskumbattu@gmail.com



## ğŸ“ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit a Pull Request. For major changes:

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

### Development Guidelines
- Maintain code documentation standards
- Test with both synthetic and real data
- Update README for new features
- Follow MATLAB style guidelines

## ğŸ› Issues

Found a bug or have a suggestion? Please [open an issue] with:
- Clear description of the problem
- Steps to reproduce
- Expected vs actual behavior
- MATLAB version and OS
- Sample data if possible

## ğŸ™ Acknowledgments

- **University of Sydney** for supporting this research
- **IEEE Engineering in Medicine & Biology Society** for publishing the original work
- **Sleep Research Group, Charles Perkins Centre** for clinical expertise
- **Royal North Shore Hospital** for providing research infrastructure
- All contributors and users of this code

## ğŸ“š References

1. **Sebastian, A., et al.** (2021). Unsupervised Approach for the Identification of the Predominant Site of Upper Airway Collapse in Obstructive Sleep Apnoea Patients Using Snore Signals. *IEEE EMBC 2021*.

2. **Rousseeuw, P. J.** (1987). Silhouettes: A graphical aid to the interpretation and validation of cluster analysis. *Journal of Computational and Applied Mathematics*, 20, 53-65.

3. **He, X., Cai, D., & Niyogi, P.** (2006). Laplacian score for feature selection. *Advances in Neural Information Processing Systems*, 507-514.

4. **MacQueen, J.** (1967). Some methods for classification and analysis of multivariate observations. *Proceedings of the Fifth Berkeley Symposium on Mathematical Statistics and Probability*, 1(14), 281-297.



â­ **Star this repository** if you find it useful!  
ğŸ”” **Watch** for updates and new features  
ğŸ´ **Fork** to contribute or customize for your research

**Made with â¤ï¸ for the sleep research and machine learning community**